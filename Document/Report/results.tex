\chapter{Results}
\label{chap:results}

\section{The program}

\setlength{\screenshotwidth}{.475\textwidth}
%\setlength{\screenshotwidth}{.45\textwidth}

%\setlength{\screenshotunitlength}{.325\textwidth}
%\setlength{\screenshotunitlength}{.305\textwidth}
\setlength{\screenshotunitlength}{.295\textwidth}

%\setlength{\initiallinewidth}{.25pt}
\setlength{\initiallinewidth}{.20pt}

% 1 --- l
% 2 --- Z
% 3 --- E
% 4 --- A
% 5 --- S
% 6 --- G
% 7 --- T
% 8 --- B
% 9 --- g
% 0 --- O
\begin{figure}
    \centering
    \subcaptionbox{$t = 0 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_0}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.075 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_0.075}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.15 \text{ s}$}[\screenshotwidth]{
       \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
       \input{Images/Screenshots/screenshot_alpha_at_0.15}
       \end{tikzpicture}
    }
    \subcaptionbox{\label{fig:screenshots_alpha_O_E}$t = 0.3 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_0.3}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.6 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_0.6}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.9 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_0.9}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 1.25 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_1.25}
        \end{tikzpicture}
    }
    \subcaptionbox{\label{fig:screenshots_alpha_l_TS}$t = 1.75 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_alpha_at_1.75}
        \end{tikzpicture}
    }
    \caption{Phase fraction, $\alpha$, for certain values of the time since simulation start, in a dam break simulation. Red indicates only water, while blue indicates only air. The colors in between indicates a mix between water and air. White indicates cells that have not been brought into the simulation yet.}
    \label{fig:screenshots_alpha}
\end{figure}

\begin{figure}
    \centering
    \subcaptionbox{$t = 0 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.075 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0.075}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.15 \text{ s}$}[\screenshotwidth]{
       \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
       \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0.15}
       \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.3 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0.3}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.6 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0.6}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.9 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_0.9}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 1.25 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_1.25}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 1.75 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_water_volume_coefficient_at_1.75}
        \end{tikzpicture}
    }
    \caption{Water density coefficient for certain values of the time since simulation start, in a dam break simulation. Red indicates the water density that is required to get atmospheric pressure if no air is mixed with the water; a shift against purple or against blue indicates a higher or a lower water density, respectively. Blue indicates no water. White indicates cells that have not been brought into the simulation yet.}
    \label{fig:screenshots_water_volume_coefficient}
\end{figure}

\begin{figure}
    \centering
    \subcaptionbox{$t = 0 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.075 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0.075}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.15 \text{ s}$}[\screenshotwidth]{
       \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
       \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0.15}
       \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.3 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0.3}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.6 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0.6}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 0.9 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_0.9}
        \end{tikzpicture}
    }
    \subcaptionbox{$t = 1.25 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_1.25}
        \end{tikzpicture}
    }
    \subcaptionbox{\label{fig:screenshots_almost_vacuum}$t = 1.75 \text{ s}$}[\screenshotwidth]{
        \begin{tikzpicture}[x={(\screenshotunitlength,0)},y={(0,\screenshotunitlength)}]
        \input{Images/Screenshots/screenshot_air_volume_coefficient_at_1.75}
        \end{tikzpicture}
    }
    \caption{Air density coefficient for certain values of the time since simulation start, in a dam break simulation. Red indicates the air density that is required to get atmospheric pressure if no water is mixed with the air; a shift against purple or against blue indicates a higher or a lower air density, respectively. Blue indicates no air. White indicates cells that have not been brought into the simulation yet.}
    \label{fig:screenshots_air_volume_coefficient}
\end{figure}

% Pros:

The program that was created could successfully simulate water and air and keep the two phases separated, with a region of cells containing a mix of both water and air in between the two phases. Pressure waves, or acoustic waves, within the fluids as well as gravity waves, or surface waves, on the surface in the interface between the water and the air were successfully simulated.

% Cons:

However, the method that was chosen, which was the \FVM on an \octree data structure together with the \VOF method, proved to be quite advanced and difficult to implemented properly within the time frame for \thismasterthesiswork. The simulations suffered from numerous problems for which there wasn't enough time to implement any remedy. Here is a list over those issues:

%The limitation of the Courant number is a big problem, as it prevents the simulation from taking as large time steps as it would have to; this could maybe be remedied by switching from explicit to implicit methods. On the other hand, it can now manage to propagate surface waves.

\begin{itemize}
    \item Vacuum could suddenly occur in the air regions, causing a numerical instability that would spread as a wildfire through the entire simulation domain and "eat up" the contents of all other cells.
    
    Specifically, the problem was that the vacuum cells caused velocities to go to infinity. With constant time step, this would lead to numerical instabilities, while with an adaptive time step, it would lead to that the \timestep would go to zero as the cell density went to zero, and the simulation would eventually freeze completely. No matter which case, one of the cells would eventually lose all its content, starting a numerical instability that quickly would spread through all other cells and "eat up" all air and water.
    
    This can be seen in \figref{fig:screenshots_air_volume_coefficient}, in which the air density divided by a fixed reference value has been rendered for a dam break simulation, for certain time values after the simulation start. In \figref{fig:screenshots_almost_vacuum}, the air has almost turned to a vacuum in the upper right corner.
    
    \item The simulation speed was extremely low. Even though the tests carried out during the development of the program were only held in two dimensions, which heavily reduced the number of cells that had to be processed every time step, the simulation still went many times slower than real-time speed. This was partly due to the fact that no optimization, including parallelization of the code, was ever made, and partly due to the fact that the time step was restricted by the \CFL condition, which forced the time step to be as low as 0.3~ms for which more than \mbox{3,000} time steps per second would have been necessary in order to obtain a real-time speed.
    
    As a hint of the simulation speed, the simulation illustrated in \figrefs \ref{fig:screenshots_alpha}--\ref{fig:screenshots_air_volume_coefficient} took in the order of magnitude one minute when simulated single-threadedly on a laptop with a \mbox{2.5 GHz} Intel Core \mbox{i5-3210M} \CPU.
    
    \item There were problems with keeping the interface intact (see \figrefs \mbox{\ref{fig:screenshots_alpha_O_E}--\subref{fig:screenshots_alpha_l_TS}}). The variant of the \idx{Hyper-C} advection scheme that was implemented did not keep the interface compressed and water was churned up in the air and formed something that most closely resembled a kind of mist, which is bad for several reasons.
    
    First, visualization becomes more difficult since it becomes more difficult to determine where the surface is located.
    
    Second, since all cells that are at least partially filled with water have to be processed, a thick interface will require more processing each frame than a thin interface, which decreases the simulation speed significantly since it is in the interface the majority of cells are located. This is illustrated in the screen shots of a dam break simulation, \figrefs \ref{fig:screenshots_alpha}--\ref{fig:screenshots_air_volume_coefficient}, where cells that are processed are colored whilst cells that are not are white. Notice how the amount of cells that are processed grows continuously, until they cover the entire simulation domain.
    
    Third, the quality of the simulation will suffer, since a thick interface is a bad approximation of a real interface between two immiscible fluids, which practically has no thickness. This naturally leads to numerical errors in the simulation, for example incorrect wave speeds for short wavelengths.
    
    It is unknown whether the fact that the interface grew so thick is a property of the Hyper-C advection scheme, if it was because the advection scheme was implemented incorrectly, or if it was because the advection scheme was generalized from only being able to cope with \idxsp{incompressible}{flow}{s} to being able to cope with \idxsp{compressible}{flow}{s} as well incorrectly.% is a complication that easily arises when trying to generalize these kinds of interface compressing advection schemes from only \idxsp{incompressible}{flow}{s} to \idxsp{compressible}{flow}{s}.% It is also unknown whether the thickness of the interface would grow arbitrarily large if the simulation would continue to go on without suffering from numerical instability, or if the thickness would eventually stabilize at a certain level.
\end{itemize}

Any measurements of the performance of the program, or of the simulation accuracy, were never really taken, since the program went so slow anyway, and suffered from so many problems that needed to be fixed, which made the program practically unusable for real-time simulations. Hence, such measurements just felt irrelevant and unnecessary.

\section{A two-dimensional PDE for water waves at varying water depths}

In \appref{apdx:pde_derivation}, a two-dimensional \PDE in the spatial domain, describing the time evolution of surface waves for intermediate, mildly varying water depths was developed. As it turned out, the \PDE required an operator that used the convolution between a convolution kernel and the free surface elevation. Furthermore, the convolution kernel was not constant, but depended on the location on the surface at which the concolution was to be calculated. While the convolution could probably have been calculated in $O(N)$ time for the entire surface --- where $N$ is the number of surface grid points --- using the continuous fast multipole method (CFMM), CFMM itself uses a quite complex algorithm, and it was assumed that altogether, solving the \PDE numerically would be too computationally expensive and would therefore not have been possible in real-time, so the method was abandoned.

\section{Study of other methods}

Parallel to implementing the program that was the topic of last section, a great deal of literature was studied in order to acquire the knowledge required to develop the technology necessary for the method to work, this naturally also lead to reading literature that was related to the objective of \thismasterthesiswork, but not completely related to the method used in the program.

As was discovered, the majority of today's existing implementations for real-time simulation of water surface waves use \idxs{Fourier}{synthesis}, and probably the vast majority of the rest of the implementations use methods that are \idx{two-dimensional} in nature, such as the \LPD method or the shallow water equations. It was noted that \LPD would perhaps fit best for this problem of all methods studied, since it is capable of simulating \FSI, as well as dispersion and wave shoaling. If wave shoaling is not a requirement, the Fourier synthesis method could perhaps be used, assuming it can simulate \FSI, which tentatively can be achieved with some of the methods covered in \secref{sec:illumination_model_derivation}.