\chapter{Derivation of an illumination model for sea surfaces}
\label{chap:illumination_model_derivation}

\begin{itemize}
\item Reflection coefficient
\item Transmission term
\item Slope of the surface
\item Chance of shading/hiding
\end{itemize}

\HRule

%To be written \comment
{
If we simplify a water surface by cutting off a part of the \idxs{wave}{spectrum}, we need to --- for \rendering purposes --- compensate for that by making the \reflection in the \idxs{simplified}{water surface} \idxse{diffuse}{reflection}{diffuse}. The \idxs{illumination}{model} derived in this appendix models this diffusion and was developed outside of the scope of \thismasterthesiswork.

\section{Microfacets}

Although the high frequencies have been removed from the rendering, which makes it impossible to treat them directly, it is possible to treat them statistically by making a few \assumptions and \approximations, and by using something known as \microfacets, which are basically infinitesimal surface elements for which the \idxs{surface}{normal} is \stochastic but \assumed to have a known \idxs{probability}{distribution}, tiled one after each other.

Let's start by calculating the \idxs{probability}{distribution} for the direction of a reflected \ray, so we can know the likelyhood that what is reflected in the water surface is the \sun. But before we can start doing that, we need to make a few \assumptions.

First, let's \assume that all frequencies of the wave spectrum is superposed linearly on top of each other and that there is no \idxs{horizontal}{displacement}, i.e.\ the waves are not \idxsp{Gerstner}{wave}{s}, or that the \idxs{wave}{amplitude} is much smaller than the \wavelength which will virtually linearize the waves and also make the horizontal displacement very small in comparison to the wavelength.

Second, to make things simpler, let's assume that both the fraction of the water surface that is hidden behind other waves and hence is not visible to the observer, and the fraction of the surface that is shadowed, i.e. is hidden from the sun behind other waves, are almost zero.

Now, let's call the \index{elevation!free surface|see{free surface elevation}}\idxs{free}{surface elevation} of the actual water surface $\eta$, and the free surface elevation of the simplified surface (from which a part of the wave spectrum has been cut off) $\eta_0$, and make them functions of $\vec{r}$ which is a \twodimensional vector in the horizontal plane. We can start by noting that $\eta_0$ contains less information about the actual water surface than $\eta$, and that $\eta_0$ is known, whereas $\eta$ is not.

We can therefore only calculate the normal of the simplified surface, let's call this $\normvec{n}_0$. Let's also define the \idx{anti-normalization} $\anormvec{\xi}$ of a vector $\vec{\xi}$ as

\begin{equation}
\anormvec{\xi} \,=\, \frac{\vec{\xi}}{\normvec{z}\cdot\vec{\xi}}\,,
\end{equation}

where $\normvec{z}$ is the \idxs{unit}{vector} in the positive vertical direction (which is the negation of the direction of the \idxs{gravitational acceleration}{vector}, or the normal of a flat water surface). This implies that the $\normvec{z}$-component of an anti-normalized vector always is 1. The \idx{anti-normal} $\anormvec{n}_0$ of $\eta_0$ becomes

\begin{equation}
\anormvec{n}_0 \,=\, \left(\!\!\!\begin{array}{c}-\nabla\eta_0(\vec{r}) \\ 1\end{array}\!\!\!\right),
\end{equation}

where the last component is the $\normvec{z}$-component. The \gradient in turn can be rewritten as

\begin{equation}
\nabla\eta_0(\vec{r}) \,=\, \nabla\mathcal{F}^{-1}\{\fdfunc{\eta}_0(\vec{k})\}(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}_0(\vec{k})\}(\vec{r}),
\end{equation}

where $\mathcal{F}^{-1}$ is the \index{operator!inverse non-uniform Fourier transform|see{inverse non-uniform Fourier transform operator}}\index{non-uniform Fourier transform operator!inverse|see{inverse non-uniform Fourier transform operator}}\idxs{inverse non-uniform}{Fourier transform operator}, $\fdfunc{\eta}_0(\vec{k})$ is the \idxs{Fourier}{transform} of $\eta_0(\vec{r})$ and $\vec{k}$ is the \idxs{wave}{vector}. Since $\eta$ is unknown, the anti-normal of the real surface, $\anormvec{n}$, cannot be calculated, although it can still be written as

\begin{equation}
\anormvec{n} \,=\, \left(\!\!\!\begin{array}{c}-\nabla\eta(\vec{r}) \\ 1\end{array}\!\!\!\right),
\end{equation}

where the gradient can be written as

\begin{equation}
\nabla\eta(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}(\vec{k})\}(\vec{r}),
\end{equation}

and where $\fdfunc{\eta}(\vec{k})$ is the \idxs{Fourier}{transform} of $\eta$. However, only the part of $\fdfunc{\eta}(\vec{k})$ where $\vec{k}$ is small enough is known; in fact, this part is equal to $\fdfunc{\eta}_0(\vec{k})$, while the reminding part of $\fdfunc{\eta}(\vec{k})$,

\begin{equation}
\fdfunc{\eta}'(\vec{k}) \,=\, \fdfunc{\eta}(\vec{k}) - \fdfunc{\eta}_0(\vec{k}),
\end{equation}

is unknown. On the other hand, if we know what the \idxs{wave}{spectrum} looks like, we can calculate the \idxs{probability}{distribution} of $\eta$.

If $\vec{r}$ is assumed to be \idxse{uniform}{distribution}{uniformly distributed} over a large surface area, i.e. there is no \bias in the distribution of $\vec{r}$ regarding to the surface slope $\nabla\eta$ or any other local property of the surface for that matter, the distribution of $\fdfunc{\eta}'$ is directly given by the wave spectrum. And from that distribution we will be able to get something we are going to need later, namely the distribution of $\nabla\eta'$.

\subsection{Wave spectra}

Almost every \idxs{wave}{spectrum}, $S$, used in \idxs{computer}{graphics}, is a function of the wave vector $\vec{k}$ and gives the \variance of the free surface elevation --- what we call $\eta$ --- per unit \idxs{reciprocal}{length} squared (the elements of $\vec{k}$ are reciprocal lengths), and thus has the unit $\text{m}^4$. If $S$ assumes that the wave components corresponding to the wave vectors are on exponential form ($e^{i(\vec{k}\cdot\vec{r}-\omega t)}$), which is what $\fdfunc{\eta}$ also assumes, rather than on a \sinusoidal form ($\sin(\vec{k}\cdot\vec{r}-\omega t)$), which otherwise is a pretty common case in computer graphics, this means that

\begin{equation} \label{eq:wave_spectrum_definition}
S(\vec{k}) \,=\, \frac{\opd \Var(\eta(\vec{r}))}{\opd\vec{k}^{\,2}},
\end{equation}

where $\Var$ denotes the \variance of $\eta$ on any given location $\vec{r}$ and $\opd\vec{k}^{\,2}$ is an \infinitesimal \idxs{reciprocal}{area} element, centered around $\vec{k}$. Here, $\opd \Var(\eta(\vec{r}))$ denotes the additional variance of $\eta$ caused solely by the part of the wave spectrum specified by $\opd\vec{k}^{\,2}$.

\eqref{eq:wave_spectrum_definition} implies that the additional variance of $\eta$, $\Delta\Var(\eta)$, caused by a part of the wave spectrum specified by a small reciprocal area element $\Delta\vec{k}^{\,2}$ is

\begin{equation}
\Delta\Var(\eta) \,=\, \int_{\Delta\vec{k}^{\,2}}\opd \Var(\eta(\vec{r})) \,=\, \int_{\Delta\vec{k}^{\,2}}\frac{\opd \Var(\eta(\vec{r}))}{\opd\vec{k}^{\,2}}\opd\vec{k}^{\,2} \,=\, \int_{\Delta\vec{k}^{\,2}}S(\vec{k})\opd\vec{k}^{\,2}.
\end{equation}

Since there is no \correlation between wave components of different \wavelengths, $\Delta\Var(\eta)$ in turn can be rewritten as

\begin{equation}
\Var(\Delta\eta(\vec{r})),
\end{equation}

where

\begin{equation}
\Delta\eta(\vec{r}) \,=\, \mathcal{F}^{-1}\{\Delta\fdfunc{\eta}(\vec{k})\}(\vec{r}),
\end{equation}

where in turn

\begin{equation}
\Delta\fdfunc{\eta}(\vec{k}) \,=\, \begin{cases}
\fdfunc{\eta}(\vec{k}), & \vec{k} \in \Delta\vec{k}^{\,2} \\
0, & \text{otherwise}
\end{cases}.
\end{equation}

Besides, the average value of $\fdfunc{\eta}(\vec{k})$ is assumed to be 0 for any given wave vector $\vec{k}$, that is

\begin{equation} \label{eq:zero_expectation_value_reciprocal_space}
E[\fdfunc{\eta}(\vec{k})] \,=\, 0,
\end{equation}

where $E$ denotes the expectation value, which after an inverse Fourier transformation also results in 

\begin{equation} \label{eq:zero_expectation_value_real_space}
E[\eta(\vec{r})] \,=\, 0.
\end{equation}

Let's assume that $\eta$ is periodic in both dimensions with the period $P$ (as often is the case in \idxs{computer}{graphics}), with a large surface element $A$ (with \mbox{$|A| = P^2$}) that keeps repeating itself, such that

\begin{equation} \label{eq:water_surface_periodicity}
\eta(\vec{r}+P\normvec{x}) \,=\, \eta(\vec{r}+P\normvec{y}) \,=\, \eta(\vec{r}),\,\forall\,\vec{r},
\end{equation}

where $\normvec{x}$ and $\normvec{y}$ are the \index{vector!orthonormal basis|see{orthonormal basis vector}}\idxsp{orthonormal}{basis vector}{s} generating the \idxs{horizontal}{plane}. This implies implies that $\fdfunc{\eta}$ is discrete with \idxsp{Dirac}{impulse}{s} lying at the fixed distance $d = 2\pi/P$ from each other, such that

\begin{equation}
\fdfunc{\eta}(\vec{k}) \,=\, 4\pi^2\sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \fdfunc{\eta}(m,\,n)\delta(\vec{r} - md\normvec{x} - nd\normvec{y}),
\end{equation}

where $\fdfunc{\eta}(m,\,n)$ is a \twodimensional \sequence of coefficients associated with $\fdfunc{\eta}$, and $m$ and $n$ are two integers used to number term in the \series.

By using \eqref{eq:zero_expectation_value_real_space}, and by assuming that $\vec{r}$ is \idxse{uniform}{distribution}{uniformly distributed} within $A$, the variance can be defined as

\begin{equation}
\Var(\eta) \,=\, E[|\eta - E[\eta]|^2] \,=\, E[|\eta|^2] \,=\, \frac{\displaystyle \int_A|\eta|^2(\vec{r})\opd\vec{r}^2}{A}
\end{equation}

\HRule

If we choose $\Delta\vec{k}^{\,2}$ such that it contains one of the Dirac impulses


















\HRule

Reality condition (for $\eta\in\mathbb{R}$):

\begin{equation}
\fdfunc{\eta}(-\vec{\xi}\,) \,=\, \overline{\fdfunc{\eta}(\vec{\xi}\,)}
\end{equation}

\HRule

If the \idxs{wave}{spectrum} is known, $\Var_{\vec{k}}(\Delta\fdfunc{\eta})$ is also known. Knowing this, we can calculate the mean value $\vec{\mu}$ of $\nabla\eta$,

\begin{equation}
\begin{array}{c}
\vec{\mu} \,=\, E[\nabla\eta(\vec{r})] \,=\, E\left[\mathcal{F}^{-1}\left\{\vec{k}\,\fdfunc{\eta}(\vec{k})\right\}(\vec{r})\right] \\
=\, E\left[\mathcal{F}^{-1}\left\{\vec{k}\,\left(\fdfunc{\eta}_0(\vec{k})+\Delta\fdfunc{\eta}(\vec{k})\right)\right\}(\vec{r})\right] \\
=\, \mathcal{F}^{-1}\left\{\vec{k}\,\left(E_{\vec{k}}[\fdfunc{\eta}_0]+E_{\vec{k}}[\Delta\fdfunc{\eta}]\right)\right\}(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}_0(\vec{k})\}(\vec{r}) \,=\, \nabla\eta_0(\vec{r})\,.
\end{array}
\end{equation}

\textit{\href{http://en.wikipedia.org/wiki/Multivariate\_normal\_distribution\#Non-degenerate\_case}{Multivariate normal distribution}}

\HRule





















\section{The rendering equation}

When doing \idxs{physically based}{rendering}, one often starts from an equation known as the \idxs{rendering}{equation}, which was simultaneously introduced in \idxs{computer}{graphics} in \citep{temp} and \citep{temp}, and is given as

\begin{equation} \label{eq:rendering_equation_original}
\begin{array}{c}
L_{\text{o}}(\vec{r},\,\normvec{\omega}_{\text{o}},\, \lambda,\, t) \,= \\
\displaystyle L_{\text{e}}(\vec{r},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t) \ + \ \int_\Omega \rho'_{\text{r}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}},
\end{array}
\end{equation}

where $L_{\text{o}}$ is the total \idxs{spectral}{radiance} of \index{light!wavelength}\idxe{wavelength!light}{wavelength} $\lambda$ directed outward along direction $\normvec{\omega}_{\text{o}}$ at time $t$, from location $\vec{r}$ at the surface; $L_{\text{e}}$ is the spectral radiance emitted by the surface itself, $\rho'_{\text{r}}$ is the \BRDF which was first defined in \citep{temp} and describes how light from different directions are reflected on the surface, $L_{\text{i}}$ is the \idxs{spectral}{radiance} incoming from direction $\normvec{\omega}_{\text{i}}$, $\normvec{n}$ is the \idxs{surface}{normal}, and $\Omega$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming reflected light, and thus all possible values for $\normvec{\omega}_{\text{i}}$ (but also all possible values for $\normvec{\omega}_{\text{o}}$). Note that both $\normvec{\omega}_{\text{i}}$ and $\normvec{\omega}_{\text{o}}$ are directed outwards from the surface.

While this equation can lay the foundation for many very realistic renderings of \threedimensional scenes, and can make the reflective properties of a surface vary for different positions, for different points in time, for different wavelengths, which allows the surface to have a color and not just a gray-scale, and even for different rotations of the surface, there are several aspects of light it can't grasp. Some of these aspects, which are relevant to \surfacewaterrendering, include

\begin{itemize}
\item \textbf{\idxe{polarisation}{Polarization}:} Light polarized differently will sometimes have different reflection distributions, as in the case of light being reflected at a water surface.

\item \textbf{\idxe{transmission}{Transmission}:} Occurs when light is transmitted through the surface, as when it hits a glass object or a water surface.

\item \textbf{\idxse{subsurface}{scattering}{Subsurface scattering}:} Many materials exhibits the property that much of the incoming light is transmitted through the surface at one location, scattered, and transmitted back through the surface at a slightly different location. If such a material is rendered without taking subsurface scattering into account, it may appear plastic, and sometimes also unnaturally opaque.

However, it is not necessary to account specifically for this in the rendering equation if it includes transmission, since that will effectively also include light scattered under the surface, even if the rendering equation still doesn't provide a model for how the light is scattering under the surface.
\end{itemize}

Of these aspects, polarization and transmission are the two aspects that are the easiest to model. Subsurface scattering also plays a role, though, but it is not going to be modeled in this appendix.

Other aspects of light, which are not relevant to \surfacewaterrendering (but are still included in this report for leisure reading), include

\begin{itemize}
\item \textbf{\idxe{phosphorescence}{Phosphorescence}:} Light or other electromagnetic radiation is sometimes absorbed at one point in time and emitted at a later point in time, usually with a lower frequency (unless the absorbed electromagnetic radiation is very intense).

If the absorption and the emission occurs at the same point in time, but with different frequencies, this is called \idx{fluorescence}.
    
\item \textbf{\idxe{interference}{Interference}:} This can occur if the wave properties of light are exhibited, for example when light is passing though a \idxs{thin}{slit} or a \idxs{double}{slit}.
    
\item \textbf{\idxse{non-linear}{effect}{Non-linear effects}:} If the light is very intensive, two or more photons can sometimes hit the same electron in a material at the same time, increasing the energy of the electron with more than the energy of the individual photons. When the electron makes a transition back to a lower energy level, emission of a photon with a higher frequency is possible.
    
\item \textbf{\index{\idxse{effect!relativistic Doppler|see{relativistic Doppler effect}}}\idxse{relativistic}{Doppler effect}{Relativistic Doppler effect}:} Light that is reflected on an object that is moving with a very high speed relative to the reference frame (or to something that is observing the light) will get its wavelength changed. If the light is reflected on an object that is moving towards it, the impact will compress the photons, making the wavelength shorter which in turn makes the light blueshifted. The photons will also be packed more closely, so the photon flux will be increased. If the light instead is reflected on an object that is moving away from it, the opposite thing will happen.
\end{itemize}

To account for transmission and polarization, we will modify \eqref{eq:rendering_equation_original} into

\begin{equation} \label{eq:rendering_equation_improved}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{cl}
L_{\text{o}}(\vec{r},\,\normvec{\omega}_{\text{o}},\, \lambda,\, t) \,=\, L_{\text{e}}(\vec{r},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t) \ + \\
\displaystyle \int_{\Omega_{\text{r}}} \rho'_{\text{r}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}} \ + \\
\displaystyle \int_{\Omega_{\text{t}}} \rho'_{\text{t}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,(-\normvec{n}))\, \operatorname d \normvec{\omega}_{\text{i}} & \!\!\!\! ,
\end{array}
\end{equation}

where $\Omega_{\text{r}}$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming reflected light, $\Omega_{\text{t}}$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming transmitted light (which is also the \idxs{relative}{complement} of $\Omega_{\text{r}}$ in the \idxs{unit}{sphere}, i.e. all points in the unit sphere that are not contained in $\Omega_{\text{r}}$), and $\rho'_{\text{t}}$ is the \BTDF which describes how light from different directions are transmitted through the surface.

The parameters $\vec{r}$, $t$ and $\lambda$ can be removed from the equation since they are of no importance to the derivation of the illumination model; one will just have to keep in mind that the functions depend on $\vec{r}$ and $t$ --- however, they don't have any specific dependence on $\lambda$. Even the term $L_{\text{e}}$ can be removed since water surfaces is generally not considered to emit any electromagnetic radiation. We can therefore simplify \eqref{eq:rendering_equation_improved} somewhat to

\begin{equation} \label{eq:rendering_equation_reduced}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{cl}
L_{\text{o}}(\normvec{\omega}_{\text{o}}) \,= \\
\displaystyle \int_{\Omega_{\text{r}}} \rho'_{\text{r}}(\normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}})\, L_{\text{i}}(\normvec{\omega}_{\text{i}})\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}} \ + \\[1ex]
\displaystyle \int_{\Omega_{\text{t}}} \rho'_{\text{t}}(\normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}})\, L_{\text{i}}(\normvec{\omega}_{\text{i}})\, (\normvec{\omega}_{\text{i}}\,\cdot\,(-\normvec{n}))\, \operatorname d \normvec{\omega}_{\text{i}} & \!\!\!\! .
\end{array}
\end{equation}
