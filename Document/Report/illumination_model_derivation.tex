\chapter{Derivation of an illumination model for sea surfaces}
\label{chap:illumination_model_derivation}

\begin{itemize}
\item Reflection coefficient
\item Transmission term
\item Slope of the surface
\item Chance of shading/hiding
\end{itemize}

\HRule

%To be written \comment
{
If we simplify a water surface by cutting off a part of the \idxs{wave}{spectrum}, such the part containing all frequencies over the \idxs{Nyquist}{frequency}, we will loose surface details which we --- for \visualization purposes --- need to compensate for by making \reflections in the water surface \idxse{diffuse}{reflection}{diffuse}.

For that reason, an \idxs{illumination}{model} --- that was developed outside of the scope of \thismasterthesiswork\ \,---\ \,is derived in this appendix, and it models this diffuseness.

\section{Microfacets}

Although some of the frequencies has been removed from the rendering, and hence become impossible to treat directly, it is still possible to treat them statistically after making a few \assumptions and \approximations.

If we know the \idxs{probability}{distribution} for all removed frequencies, we can calculate the distribution for the surface normal, which means that we can calculate the distribution for the direction of a \ray that has just been reflected on the surface is we know the direction from which it came. This means that we can calculate the likelihood that the object which is being reflected in a specific point on the surface is the \sun, which in turn makes it possible to calculate the brightness of that point as perceived by the viewer. But before we can start doing that, we need to make a few \assumptions.

Let's model the surface by something known as \microfacets, which are basically infinitesimal surface elements, tiled one after each other, for which the \idxs{surface}{normal} is \assumed to be \stochastically distributed with a known \idxs{probability}{distribution} --- we will come to this later.

First, let's \assume that all frequencies of the wave spectrum are \superposed linearly on top of each other. This implies that there is no \idxs{horizontal}{displacement}, that is, either the waves are not \idxsp{Gerstner}{wave}{s}, or the \idxs{wave}{amplitude} is so much smaller than the \wavelength that it is considered negligible whether the waves are Gerstner waves or not.

Second, to make things simpler, let's assume that both the fraction of the water surface that is hidden behind other waves, and hence is not visible to the observer, and the fraction of the surface that is \shadowed, i.e. is hidden from the sun behind other waves, are almost zero.

Now, let's denote the \index{elevation!free surface|see{free surface elevation}}\idxs{free}{surface elevation} of the actual water surface as $\eta$, and the free surface elevation of the simplified surface (from which a part of the wave spectrum has been cut off) as $\eta_0$, and make them functions of $\vec{r}$ which is a \twodimensional vector in the horizontal plane. We can start by noting that $\eta_0$ contains less information about the actual water surface than $\eta$, and that $\eta_0$ is known, whereas $\eta$ is not.

We can therefore only calculate the normal of the simplified surface, let's call this $\normvec{n}_0$. Let's also define the \idx{anti-normalization} $\anormvec{\xi}$ of a vector $\vec{\xi}$ as

\begin{equation}
\anormvec{\xi} \,=\, \frac{\vec{\xi}}{\normvec{z}\cdot\vec{\xi}}\,,
\end{equation}

where $\normvec{z}$ is the \idxs{unit}{vector} in the positive vertical direction (which is the negation of the direction of the \idxs{gravitational acceleration}{vector}, or the normal of a flat water surface). This implies that the $\normvec{z}$-component of an anti-normalized vector always is 1. The \idx{anti-normal} $\anormvec{n}_0$ of $\eta_0$ becomes

\begin{equation}
\anormvec{n}_0 \,=\, \left(\!\!\!\begin{array}{c}-\nabla\eta_0(\vec{r}) \\ 1\end{array}\!\!\!\right),
\end{equation}

where the last component is the $\normvec{z}$-component. The \gradient in turn can be rewritten as

\begin{equation}
\nabla\eta_0(\vec{r}) \,=\, \nabla\mathcal{F}^{-1}\{\fdfunc{\eta}_0(\vec{k})\}(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}_0(\vec{k})\}(\vec{r}),
\end{equation}

where $\mathcal{F}^{-1}$ is the \index{operator!inverse non-unitary Fourier transform|see{inverse non-unitary Fourier transform operator}}\index{non-unitary Fourier transform operator!inverse|see{inverse non-unitary Fourier transform operator}}\idxs{inverse non-unitary}{Fourier transform operator}, $\fdfunc{\eta}_0(\vec{k})$ is the \idxs{Fourier}{transform} of $\eta_0(\vec{r})$ and $\vec{k}$ is the \idxs{wave}{vector}. Since $\eta$ is unknown, the anti-normal of the real surface, $\anormvec{n}$, cannot be calculated, although it can still be written as

\begin{equation}
\anormvec{n} \,=\, \left(\!\!\!\begin{array}{c}-\nabla\eta(\vec{r}) \\ 1\end{array}\!\!\!\right),
\end{equation}

where the gradient can be written as

\begin{equation}
\nabla\eta(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}(\vec{k})\}(\vec{r}),
\end{equation}

and where $\fdfunc{\eta}(\vec{k})$ is the \idxs{Fourier}{transform} of $\eta$. However, only the part of $\fdfunc{\eta}(\vec{k})$ where $\vec{k}$ is small enough is known; in fact, this part is equal to $\fdfunc{\eta}_0(\vec{k})$, while the reminding part of $\fdfunc{\eta}(\vec{k})$,

\begin{equation}
\fdfunc{\eta}'(\vec{k}) \,=\, \fdfunc{\eta}(\vec{k}) - \fdfunc{\eta}_0(\vec{k}),
\end{equation}

is unknown. On the other hand, if we know what the \idxs{wave}{spectrum} looks like, we can calculate the \idxs{probability}{distribution} of $\eta$.

If $\vec{r}$ is assumed to be \idxse{uniform}{distribution}{uniformly distributed} over a large surface area, i.e. there is no \bias in the distribution of $\vec{r}$ regarding to the surface slope $\nabla\eta$ or any other local property of the surface for that matter, the distribution of $\fdfunc{\eta}'$ is directly given by the wave spectrum. And from that distribution we will be able to get something we are going to need later, namely the distribution of $\nabla\eta'$.

\subsection{Wave spectra}

When using a \idxs{wave}{spectrum}, the free surface elevation, what we call $\eta$, is considered indeterministic, that is, \stochastic. Almost every \idxs{wave}{spectrum}, $S$, used in \idxs{computer}{graphics}, is a function of the wave vector $\vec{k}$ and gives the \variance of the free surface elevation per unit \idxs{reciprocal}{length} squared (the elements of $\vec{k}$ are reciprocal lengths), and thus has the unit $\text{m}^4$. 

If $S$ assumes that the wave components corresponding to the wave vectors are on exponential form ($e^{i(\vec{k}\cdot\vec{r}-\omega t)}$), which is what $\fdfunc{\eta}$ also assumes, rather than on a \sinusoidal form ($\sin(\vec{k}\cdot\vec{r}-\omega t)$), which otherwise is a pretty common case in computer graphics, this means that

\begin{equation} \label{eq:wave_spectrum_definition}
S(\vec{k}) \,=\, \frac{\opd \Var(\eta)}{\opd\vec{k}},
\end{equation}

where $\Var(\eta)$ denotes the \variance of $\eta$ with regard to $\vec{r}$, for a fixed time $t$, and $\opd\vec{k}$ is an \infinitesimal \idxs{reciprocal}{area} element, centered around $\vec{k}$. Here, $\opd\Var(\eta)$ denotes the additional variance of $\eta$ caused solely by the part of the wave spectrum specified by $\opd\vec{k}$.

\eqref{eq:wave_spectrum_definition} implies that the additional variance of $\eta$ --- $\Var_{\Delta\vec{k}}(\eta)$ --- caused by a part of the wave spectrum specified by a reciprocal area element $\Delta\vec{k}$ is

\begin{equation} \label{eq:variance_k_eta}
\Var_{\Delta\vec{k}}(\eta) \,=\, \int_{\Delta\vec{k}}\opd \Var(\eta) \,=\, \int_{\Delta\vec{k}}\frac{\opd \Var(\eta)}{\opd\vec{k}}\opd\vec{k} \,=\, \int_{\Delta\vec{k}}S(\vec{k})\opd\vec{k}.
\end{equation}

Since there is no \correlation between wave components of different \wavelengths, $\Var_{\Delta\vec{k}}(\eta)$ in turn can be rewritten as

\begin{equation} \label{eq:variance_k_eta_to_variance_eta_k}
\Var_{\Delta\vec{k}}(\eta) \,=\, \Var(\eta_{\Delta\vec{k}}),
\end{equation}

where

\begin{equation} \label{eq:eta_k_of_fd_eta_k}
\eta_{\Delta\vec{k}} \,=\, \mathcal{F}^{-1}\{\fdfunc{\eta}_{\Delta\vec{k}}(\vec{k})\},
\end{equation}

where in turn

\begin{equation}
\fdfunc{\eta}_{\Delta\vec{k}}(\vec{k}) \,=\, \begin{cases}
\fdfunc{\eta}(\vec{k}), & \vec{k} \in \Delta\vec{k} \\
0, & \text{otherwise}
\end{cases}.
\end{equation}

Besides, the average value of $\fdfunc{\eta}(\vec{k})$ is assumed to be 0 for any given wave vector $\vec{k}$, that is

\begin{equation} \label{eq:zero_expectation_value_reciprocal_space}
\E_{\vec{k}}[\fdfunc{\eta}] \,=\, 0,\ \forall\ \vec{k},
\end{equation}

where $\E_{\vec{k}}$ denotes the expectation value with regard to time, for a fixed value of $\vec{k}$. After \idxsp{inverse}{Fourier transform}{ing}, this also results in 

\begin{equation} \label{eq:zero_expectation_value_real_space_with_regard_to_t}
\E_{\vec{r}}[\eta] \,=\, 0,\ \forall\ \vec{r},
\end{equation}

where $\E_{\vec{r}}$ denotes the expectation value with regard to time, for a fixed value of $\vec{r}$, and can be defined as

\begin{equation} \label{eq:expectation_value_with_regard_to_t_definition}
\E_{\vec{r}}[f] \,=\, \lim_{T\to\infty}\frac{1}{T}\int_0^T f(\vec{r},\,t)\opd t,
\end{equation}

where $f$ is a function of $\vec{r}$ and $t$.

Let's assume that $\eta$ is periodic in both dimensions with the period $P$ (as often is the case in \idxs{computer}{graphics}) with a large surface element $A$ (with \mbox{$|A| = P^2$}) that keeps repeating itself, such that

\begin{equation} \label{eq:water_surface_periodicity}
\eta(\vec{r}+P\normvec{x}) \,=\, \eta(\vec{r}+P\normvec{y}) \,=\, \eta(\vec{r}),\ \forall\ \vec{r},
\end{equation}

where $\normvec{x}$ and $\normvec{y}$ are the \index{vector!orthonormal basis|see{orthonormal basis vector}}\idxsp{orthonormal}{basis vector}{s} generating the \idxs{horizontal}{plane}. This implies implies that $\fdfunc{\eta}$ is discrete with \idxsp{Dirac}{impulse}{s} lying at the fixed distance $d = 2\pi/P$ from each other, such that

\begin{equation} \label{eq:fd_eta_series}
\renewcommand*{\arraystretch}{2}
\begin{array}{c}
\displaystyle \fdfunc{\eta}(\vec{k}) \,=\, 4\pi^2\sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \fdfunc{\eta}(m,\,n)\,\delta(\vec{k} - md\normvec{x} - nd\normvec{y}) \\
\displaystyle =\, 4\pi^2\sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \fdfunc{\eta}(m,\,n)\,\delta(\vec{k} - \vec{k}_{m,n}),
\end{array}
\end{equation}

where $\fdfunc{\eta}(m,\,n)$ is a \twodimensional \sequence of coefficients associated with $\fdfunc{\eta}$, $m$ and $n$ are two integers used to index the terms in the \series, and $\vec{k}_{m,n} = md\normvec{x} + nd\normvec{y}$.

By \assuming that $\vec{r}$ is \idxse{uniform}{distribution}{uniformly distributed} within $A$, the variance can be defined as

\begin{equation} \label{eq:variance_definition}
\Var(f) \,=\, \E_{A,t}[\,|f - \E_{A,t}[f]\,|^2\,],
\end{equation}

where $\E_{A,t}$ denotes the expectation value for a $\vec{r}$ that is uniformly distributed within $A$, for a fixed time, and can be defined as

\begin{equation} \label{eq:expectation_value_with_regard_to_r_definition}
\E_{A,t}[f] \,=\, \frac{1}{A}\int_A f(\vec{r},\,t)\opd\vec{r}.
\end{equation}

By realizing that this expectation value will be time independent for $f(\vec{r}) = \varphi(\vec{r})$, where $\varphi$ is any periodic (obeying \eqref{eq:water_surface_periodicity}) free surface elevation which is mass conserving (the integral over $A$ is time independent), we can use \eqref{eq:zero_expectation_value_real_space_with_regard_to_t} and \eqref{eq:expectation_value_with_regard_to_t_definition} to get

\begin{equation} \label{eq:zero_expectation_value_real_space_with_regard_to_r}
\renewcommand*{\arraystretch}{2}
\begin{array}{c}
\displaystyle \E_{A,t}[\varphi] \,=\, \lim_{T\to\infty}\frac{1}{T}\int_0^T\frac{1}{A}\int_A \varphi(\vec{r},\,t)\opd\vec{r}\opd t \\
\displaystyle =\, \frac{1}{A}\int_A\lim_{T\to\infty}\frac{1}{T}\int_0^T \varphi(\vec{r},\,t)\opd t\opd\vec{r} \,=\, \frac{1}{A}\int_A \E_{\vec{r}}[\varphi]\opd\vec{r} \,=\, 0.
\end{array}
\end{equation}

By using using \eqref{eq:expectation_value_with_regard_to_r_definition} and \eqref{eq:zero_expectation_value_real_space_with_regard_to_r}, \eqref{eq:variance_definition} becomes

\begin{equation} \label{eq:variance_integral}
\Var(\varphi) \,=\, \frac{1}{A}\int_A|\varphi(\vec{r})|^2\opd\vec{r}.
\end{equation}

\eqref{eq:fd_eta_series} can be reduced to

\begin{equation} \label{eq:fd_eta_series_reduced}
\fdfunc{\eta}(\vec{k}) \,=\, \sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \fdfunc{\eta}_{m,n}(\vec{k}),
\end{equation}

where

\begin{equation} \label{eq:fd_eta_mn_definition}
\fdfunc{\eta}_{m,n}(\vec{k}) \,=\, 4\pi^2 \fdfunc{\eta}(m,\,n)\,\delta(\vec{k} - \vec{k}_{m,n}),
\end{equation}

and if we define $\Delta\vec{k}_{m,n}$ as a square that has the side $d$, is aligned with $\normvec{x}$ and $\normvec{y}$ and is centered in $\vec{k}_{m,n}$, we see that

\begin{equation} \label{eq:fd_eta_dk_mn_definition}
\fdfunc{\eta}_{\Delta\vec{k}_{m,n}}(\vec{k}) \,=\, \fdfunc{\eta}_{m,n}(\vec{k}).
\end{equation}

It follows naturally to do the same thing with the real space representation, $\eta(\vec{r})$, and write it as

\begin{equation} \label{eq:eta_series_reduced}
\eta(\vec{r}) \,=\, \sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \eta_{m,n}(\vec{r}),
\end{equation}

where

\begin{equation} \label{eq:eta_mn_definition}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{c}
\displaystyle \eta_{m,n}(\vec{r}) \,=\, \mathcal{F}^{-1}\{\fdfunc{\eta}_{m,n}(\vec{k})\}(\vec{r}) \,=\, \frac{1}{(2\pi)^2} \int_{\mathbb{R}^2} \fdfunc{\eta}_{m,n}(\vec{k}) e^{i\vec{k}\cdot\vec{r}}\opd \vec{k} \\
\displaystyle =\, \frac{1}{4\pi^2} \int_{\mathbb{R}^2} 4\pi^2\,\fdfunc{\eta}(m,\,n)\,\delta(\vec{k} - md\normvec{x} - nd\normvec{y}) e^{i\vec{k}\cdot\vec{r}}\opd \vec{k} \,=\, \fdfunc{\eta}(m,\,n)\,e^{i\vec{k}_{m,n}\cdot\vec{r}}.
\end{array}
\end{equation}

Taking the gradient of this yields

\begin{equation} \label{eq:grad_eta_one_dirac}
\nabla\eta_{m,n}(\vec{r}) \,=\, \nabla(\fdfunc{\eta}(m,\,n)\,e^{i\vec{k}_{m,n}\cdot\vec{r}}) \,=\, \vec{k}_{m,n}\,\fdfunc{\eta}(m,\,n)\,e^{i\vec{k}_{m,n}\cdot\vec{r}} \,=\, \vec{k}_{m,n}\,\eta_{m,n}(\vec{r}).
\end{equation}

Let's \assume that the surface gradient is \idxse{normal}{distribution}{normal distributed}. For vectors, the corresponding distribution is the \textit{\href{http://en.wikipedia.org/wiki/Multivariate\_normal\_distribution\#Non-degenerate\_case}{Multivariate normal distribution}}, and requires that the \mean as well as the \idxs{covariance}{matrix} of the vector are known. The covariance matrix, $\Sigma$, of a stochastic vector $\vec{x}$ is defined as

\begin{equation} \label{eq:covariance_matrix_element_definition}
\Sigma_{i,j}(\vec{x}) \,=\, \Cov(x_i,\,x_j) \,=\, \E[(x_i - \E[x_i])(x_j - \E[x_j])],
\end{equation}

where $\Sigma_{i,j}$ is the element at row $i$ and in column $j$ in $\Sigma$. Combining this with \eqref{eq:grad_eta_one_dirac} gives

\begin{equation} \label{eq:covariance_matrix_gradient_eta_mn}
\renewcommand*{\arraystretch}{2}
\begin{array}{c}
\Sigma(\nabla\,\eta_{m,n}(\vec{r})) \,=\, \Sigma(\vec{k}_{m,n}\,\eta_{m,n}(\vec{r})) \\
=\,
\left[\renewcommand*{\arraystretch}{1}
\begin{array}{cc}
(md)^2 & mnd^2 \\
mnd^2 & (nd)^2
\end{array}
\right]
\Var(\eta_{m,n}(\vec{r})) \,=\, \vec{k}_{m,n}\otimes\vec{k}_{m,n} \Var(\eta_{m,n}(\vec{r})),
\end{array}
\end{equation}

where $\otimes$ denotes the outer product. The covariance has the property

\begin{equation}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{rl}
\Cov(a,\,b)
& =\, \E[(a-\E[a])(b-\E[b])] \\
& =\, \E[ab - a\E[b] - \E[a]b + \E[a]\E[b]] \\
& =\, \E[ab] - \E[a]\E[b] - \E[a]\E[b] + \E[a]\E[b] \\
& =\, \E[ab] - \E[a]\E[b],
\end{array}
\end{equation}

so for two stochastically independent vectors $\vec{x}$ and $\vec{y}$, we have

\begin{equation}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{cl}
  & \Cov(x_i+y_i,\,x_j+y_j) \\
= & \E[(x_i+y_i)(x_j+y_j)] - \E[x_i+y_i]\E[x_j+y_j] \\
= & \E[x_i x_j] + \E[x_i y_j] + \E[y_i x_j] + \E[y_i y_j] \\
  & - \E[x_i]\E[x_j] - \E[x_i]\E[y_j] - \E[y_i]\E[x_j] - \E[y_i]\E[y_j] \\
= & \left/ \vec{x},\, \vec{y}\ \text{stochastically independent}\right/ \\
= & \E[x_i x_j] + \E[x_i]\E[y_j] + \E[y_i]\E[x_j] + \E[y_i y_j] \\
  & - \E[x_i]\E[x_j] - \E[x_i]\E[y_j] - \E[y_i]\E[x_j] - \E[y_i]\E[y_j] \\
= & (\E[x_i x_j] - \E[x_i]\E[x_j]) + (\E[y_i y_j] - \E[y_i]\E[y_j]) \\
= & \Cov(x_i,\,x_j) + \Cov(y_i,\,y_j),
\end{array}
\end{equation}

which implies that

\begin{equation} \label{eq:covariance_matrix_sum}
\Sigma(\vec{x} + \vec{y}) \,=\, \Sigma(\vec{x}) + \Sigma(\vec{y}).
\end{equation}

Combining this with \eqref{eq:eta_series_reduced} and \eqref{eq:covariance_matrix_gradient_eta_mn} gives

\begin{equation} \label{eq:covariance_matrix_gradient_eta}
\renewcommand*{\arraystretch}{2}
\begin{array}{c}
\displaystyle \Sigma(\nabla\,\eta(\vec{r})) \,=\, \Sigma\left(\nabla\left(\sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty} \eta_{m,n}(\vec{r})\right)\right) \\
\displaystyle =\, \sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty}\Sigma\left(\nabla\eta_{m,n}(\vec{r})\right) \,=\, \sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty}\vec{k}_{m,n}\otimes\vec{k}_{m,n} \Var(\eta_{m,n}(\vec{r})).
\end{array}
\end{equation}

If we combine \eqref{eq:variance_k_eta}, \eqref{eq:variance_k_eta_to_variance_eta_k} and \eqref{eq:fd_eta_dk_mn_definition}, we see that

\begin{equation}
\Var(\eta_{m,n}(\vec{r})) \,=\, \Var(\eta_{\Delta\vec{k}_{m,n}}(\vec{r})) \,=\, \Var_{\Delta\vec{k}_{m,n}}(\eta(\vec{r})) \,=\, \int_{\Delta\vec{k}_{m,n}}S(\vec{k})\opd\vec{k}.
\end{equation}

\eqref{eq:covariance_matrix_gradient_eta} can be rewritten as

\begin{equation}
\Sigma(\nabla\,\eta(\vec{r})) \,=\, \sum_{m=-\infty}^{+\infty}\sum_{n=-\infty}^{+\infty}\vec{k}_{m,n}\otimes\vec{k}_{m,n} \int_{\Delta\vec{k}_{m,n}}S(\vec{k})\opd\vec{k}
\end{equation}

and since the unit of all $\Delta\vec{k}_{m,n}$ is $\mathbb{R}^2$, in the limit when $P\to\infty$ and $d\to 0$ we get

\begin{equation} \label{eq:covariance_matrix_gradient_eta_final}
\Sigma(\nabla\,\eta(\vec{r})) \,=\, \int_{\mathbb{R}^2}\vec{k}\otimes\vec{k}\,S(\vec{k})\opd\vec{k},
\end{equation}

which means that we know the covariance matrix of $\nabla\eta$. Additionally, by differentiating \eqref{eq:zero_expectation_value_real_space_with_regard_to_t}, we get

\begin{equation}
\E_{\vec{r}}[\nabla\eta] \,=\, 0,\ \forall\ \vec{r},
\end{equation}

so we know the expectation value of $\nabla\eta$ as well, which means that we know the distribution of $\nabla\eta$ since we assumed it was multivariate normal distributed. The multivariate normal distribution density $f$ of a stochastic vector $\vec{x}$ is given by

\begin{equation} \label{eq:multivariate_normal_distribution_density}
f(\vec{x}) \,=\, \frac{1}{(2\pi)^{d/2}|\Sigma|^{1/2}}\exp\left(-\frac{1}{2}(\vec{x}-\vec{\mu})^{\T}\Sigma^{-1}(\vec{x}-\vec{\mu})\right),
\end{equation}

where $d$ is the \dimensionality of $\vec{x}$, $\vec{\mu} = \E[\vec{x}]$ is the expectation value of $\vec{x}$, $\Sigma = \Sigma(\vec{x})$ is the covariance matrix of $\vec{x}$, $|\Sigma|$ is the \determinant of $\Sigma$, $\exp$ is the \idxs{exponential}{function}, and a superscripted $\T$ denotes the \transpose of a matrix (note that vectors can be treated as column matrices).

The distribution density $f$ of $\nabla\eta$ is therefore given by

\begin{equation} \label{eq:eta_grad_distribution}
f(\nabla\eta) \,=\, \frac{1}{2\pi|\Sigma|^{1/2}}\exp\left(-\frac{1}{2}(\nabla\eta)^{\T}\Sigma^{-1}(\nabla\eta)\right),
\end{equation}

where $\Sigma = \Sigma(\nabla\eta)$ is given by \eqref{eq:covariance_matrix_gradient_eta_final}.



















































































\HRule

Reality condition (for $\eta\in\mathbb{R}$):

\begin{equation}
\fdfunc{\eta}(-\vec{\xi}\,) \,=\, \overline{\fdfunc{\eta}(\vec{\xi}\,)}
\end{equation}

\HRule

If the \idxs{wave}{spectrum} is known, $\Var_{\vec{k}}(\Delta\fdfunc{\eta})$ is also known. Knowing this, we can calculate the mean value $\vec{\mu}$ of $\nabla\eta$,

\begin{equation}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{c}
\vec{\mu} \,=\, \E[\nabla\eta(\vec{r})] \,=\, E\left[\mathcal{F}^{-1}\left\{\vec{k}\,\fdfunc{\eta}(\vec{k})\right\}(\vec{r})\right] \\
=\, E\left[\mathcal{F}^{-1}\left\{\vec{k}\,\left(\fdfunc{\eta}_0(\vec{k})+\Delta\fdfunc{\eta}(\vec{k})\right)\right\}(\vec{r})\right] \\
=\, \mathcal{F}^{-1}\left\{\vec{k}\,\left(\E_{\vec{k}}[\fdfunc{\eta}_0]+\E_{\vec{k}}[\Delta\fdfunc{\eta}]\right)\right\}(\vec{r}) \,=\, \mathcal{F}^{-1}\{\vec{k}\,\fdfunc{\eta}_0(\vec{k})\}(\vec{r}) \,=\, \nabla\eta_0(\vec{r})\,.
\end{array}
\end{equation}

\HRule





















\section{The rendering equation}

When doing \idxs{physically based}{rendering}, one often starts from an equation known as the \idxs{rendering}{equation}, which was simultaneously introduced in \idxs{computer}{graphics} in \citep{temp} and \citep{temp}, and is given as

\begin{equation} \label{eq:rendering_equation_original}
\begin{array}{c}
L_{\text{o}}(\vec{r},\,\normvec{\omega}_{\text{o}},\, \lambda,\, t) \,= \\
\displaystyle L_{\text{e}}(\vec{r},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t) \ + \ \int_\Omega \rho'_{\text{r}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}},
\end{array}
\end{equation}

where $L_{\text{o}}$ is the total \idxs{spectral}{radiance} of \index{light!wavelength}\idxe{wavelength!light}{wavelength} $\lambda$ directed outward along direction $\normvec{\omega}_{\text{o}}$ at time $t$, from location $\vec{r}$ at the surface; $L_{\text{e}}$ is the spectral radiance emitted by the surface itself, $\rho'_{\text{r}}$ is the \BRDF which was first defined in \citep{temp} and describes how light from different directions are reflected on the surface, $L_{\text{i}}$ is the \idxs{spectral}{radiance} incoming from direction $\normvec{\omega}_{\text{i}}$, $\normvec{n}$ is the \idxs{surface}{normal}, and $\Omega$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming reflected light, and thus all possible values for $\normvec{\omega}_{\text{i}}$ (but also all possible values for $\normvec{\omega}_{\text{o}}$). Note that both $\normvec{\omega}_{\text{i}}$ and $\normvec{\omega}_{\text{o}}$ are directed outwards from the surface.

While this equation can lay the foundation for many very realistic renderings of \threedimensional scenes, and can make the reflective properties of a surface vary for different positions, for different points in time, for different wavelengths, which allows the surface to have a color and not just a gray-scale, and even for different rotations of the surface, there are several aspects of light it can't grasp. Some of these aspects, which are relevant to \surfacewaterrendering, include

\begin{itemize}
\item \textbf{\idxe{polarisation}{Polarization}:} Light polarized differently will sometimes have different reflection distributions, as in the case of light being reflected at a water surface.

\item \textbf{\idxe{transmission}{Transmission}:} Occurs when light is transmitted through the surface, as when it hits a glass object or a water surface.

\item \textbf{\idxse{subsurface}{scattering}{Subsurface scattering}:} Many materials exhibits the property that much of the incoming light is transmitted through the surface at one location, scattered, and transmitted back through the surface at a slightly different location. If such a material is rendered without taking subsurface scattering into account, it may appear plastic, and sometimes also unnaturally opaque.

However, it is not necessary to account specifically for this in the rendering equation if it includes transmission, since that will effectively also include light scattered under the surface, even if the rendering equation still doesn't provide a model for how the light is scattering under the surface.
\end{itemize}

Of these aspects, polarization and transmission are the two aspects that are the easiest to model. Subsurface scattering also plays a role, though, but it is not going to be modeled in this appendix.

Other aspects of light, which are not relevant to \surfacewaterrendering (but are still included in this report for leisure reading), include

\begin{itemize}
\item \textbf{\idxe{phosphorescence}{Phosphorescence}:} Light or other electromagnetic radiation is sometimes absorbed at one point in time and emitted at a later point in time, usually with a lower frequency (unless the absorbed electromagnetic radiation is very intense).

If the absorption and the emission occurs at the same point in time, but with different frequencies, this is called \idx{fluorescence}.
    
\item \textbf{\idxe{interference}{Interference}:} This can occur if the wave properties of light are exhibited, for example when light is passing though a \idxs{thin}{slit} or a \idxs{double}{slit}.
    
\item \textbf{\idxse{non-linear}{effect}{Non-linear effects}:} If the light is very intensive, two or more photons can sometimes hit the same electron in a material at the same time, increasing the energy of the electron with more than the energy of the individual photons. When the electron makes a transition back to a lower energy level, emission of a photon with a higher frequency is possible.
    
\item \textbf{\index{\idxse{effect!relativistic Doppler|see{relativistic Doppler effect}}}\idxse{relativistic}{Doppler effect}{Relativistic Doppler effect}:} Light that is reflected on an object that is moving with a very high speed relative to the reference frame (or to something that is observing the light) will get its wavelength changed. If the light is reflected on an object that is moving towards it, the impact will compress the photons, making the wavelength shorter which in turn makes the light blueshifted. The photons will also be packed more closely, so the photon flux will be increased. If the light instead is reflected on an object that is moving away from it, the opposite thing will happen.
\end{itemize}

To account for transmission and polarization, we will modify \eqref{eq:rendering_equation_original} into

\begin{equation} \label{eq:rendering_equation_improved}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{cl}
L_{\text{o}}(\vec{r},\,\normvec{\omega}_{\text{o}},\, \lambda,\, t) \,=\, L_{\text{e}}(\vec{r},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t) \ + \\
\displaystyle \int_{\Omega_{\text{r}}} \rho'_{\text{r}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}} \ + \\
\displaystyle \int_{\Omega_{\text{t}}} \rho'_{\text{t}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}},\, \lambda,\, t)\, L_{\text{i}}(\vec{r},\, \normvec{\omega}_{\text{i}},\, \lambda,\, t)\, (\normvec{\omega}_{\text{i}}\,\cdot\,(-\normvec{n}))\, \operatorname d \normvec{\omega}_{\text{i}} & \!\!\!\! ,
\end{array}
\end{equation}

where $\Omega_{\text{r}}$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming reflected light, $\Omega_{\text{t}}$ is the \idxs{unit}{hemisphere} containing all possible directions for the incoming transmitted light (which is also the \idxs{relative}{complement} of $\Omega_{\text{r}}$ in the \idxs{unit}{sphere}, i.e. all points in the unit sphere that are not contained in $\Omega_{\text{r}}$), and $\rho'_{\text{t}}$ is the \BTDF which describes how light from different directions are transmitted through the surface.

The parameters $\vec{r}$, $t$ and $\lambda$ can be removed from the equation since they are of no importance to the derivation of the illumination model; one will just have to keep in mind that the functions depend on $\vec{r}$ and $t$ --- however, they don't have any specific dependence on $\lambda$. Even the term $L_{\text{e}}$ can be removed since water surfaces is generally not considered to emit any electromagnetic radiation. We can therefore simplify \eqref{eq:rendering_equation_improved} somewhat to

\begin{equation} \label{eq:rendering_equation_reduced}
\renewcommand*{\arraystretch}{1.5}
\begin{array}{cl}
L_{\text{o}}(\normvec{\omega}_{\text{o}}) \,= \\
\displaystyle \int_{\Omega_{\text{r}}} \rho'_{\text{r}}(\normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}})\, L_{\text{i}}(\normvec{\omega}_{\text{i}})\, (\normvec{\omega}_{\text{i}}\,\cdot\,\normvec{n})\, \operatorname d \normvec{\omega}_{\text{i}} \ + \\[1ex]
\displaystyle \int_{\Omega_{\text{t}}} \rho'_{\text{t}}(\normvec{\omega}_{\text{i}},\, \normvec{\omega}_{\text{o}})\, L_{\text{i}}(\normvec{\omega}_{\text{i}})\, (\normvec{\omega}_{\text{i}}\,\cdot\,(-\normvec{n}))\, \operatorname d \normvec{\omega}_{\text{i}} & \!\!\!\! .
\end{array}
\end{equation}
